<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CRM - Deals & Payments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #0d0d0d;
      color: white;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: #111;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid gold;
    }
    .navbar a {
      color: gold;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .container {
      padding: 20px;
    }
    .form-card, .deal-card {
      background: #1a1a1a;
      border: 1px solid gold;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.05);
    }
    h2, h3 {
      color: gold;
      border-bottom: 1px solid gold;
      padding-bottom: 5px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid gold;
      background: #1a1a1a;
      color: white;
    }
    button {
      background: linear-gradient(to right, #ffd700, #ffcc00);
      color: black;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
    .breakdown-box {
      background: #222;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px dashed gold;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="leads.html">üë• Leads</a>
    <a href="projects.html">üèóÔ∏è Projects</a>
    <a href="sales.html">üîÅ Sales Flow</a>
    <a href="https://luxurylivingcrm.42web.io/documents.html">üìÅ Documents</a>
    <a href="reports.html">üìà Reports</a>
  </div>

  <div class="container">
    <div class="form-card">
      <h3>Create Deal</h3>
      <form id="dealForm">
        <label>Lead:</label>
        <select name="lead_id" id="leadSelect" required></select>

        <label>Project:</label>
        <select name="project_id" id="projectSelect" required></select>

        <label>Unit:</label>
        <select name="unit_id" id="unitSelect" required></select>

        <label>Project Type:</label>
        <input type="text" name="project_type" id="projectType" readonly />

        <label>Property Type:</label>
        <input type="text" name="property_type" id="propertyType" readonly />

        <label>Payment Term (months):</label>
        <input type="text" name="payment_term" id="paymentTerm" readonly />

        <label>Primary Agent:</label>
        <select name="primary_agent" id="primaryAgent" required></select>

        <label>Secondary Agent (optional):</label>
        <select name="secondary_agent" id="secondaryAgent"></select>

        <label>Is this an affiliate deal?</label>
        <select name="is_affiliate" id="isAffiliate">
          <option value="">No</option>
          <option value="yes">Yes</option>
        </select>

        <label>Sale Price:</label>
        <input type="number" name="sale_price" id="salePrice" readonly />

        <label>Discount:</label>
        <input type="number" name="discount" id="discount" value="0" />

        <label>Final Price:</label>
        <input type="number" name="final_price" id="finalPrice" readonly />

        <div class="breakdown-box" id="paymentBreakdown" style="display:none"></div>

        <label>Commission (Total):</label>
        <input type="number" name="commission" id="commission" readonly />

        <label>Status:</label>
        <select name="status" required>
          <option value="open">Open</option>
          <option value="closed-won">Closed - Won</option>
          <option value="closed-lost">Closed - Lost</option>
        </select>

        <label>Notes:</label>
        <textarea name="notes"></textarea>

        <button type="submit">Save Deal</button>
      </form>
    </div>

    <div class="deal-card">
      <h3>All Deals</h3>
      <div id="dealsList"></div>
    </div>
  </div>

  <script>
    const dbDeals = new PouchDB('crm_deals');
    const dbLeads = new PouchDB('crm_leads');
    const dbInventory = new PouchDB('crm_inventory');
    const dbProjects = new PouchDB('crm_projects');
    const dbUsers = new PouchDB('crm_users');
    let projectMap = {};

    async function loadOptions() {
      const [leadRes, unitRes, userRes, projectRes] = await Promise.all([
        dbLeads.allDocs({ include_docs: true }),
        dbInventory.allDocs({ include_docs: true }),
        dbUsers.allDocs({ include_docs: true }),
        dbProjects.allDocs({ include_docs: true })
      ]);

      document.getElementById('leadSelect').innerHTML = leadRes.rows.map(r => `<option value="${r.doc._id}">${r.doc.Name}</option>`).join('');
      document.getElementById('unitSelect').innerHTML = unitRes.rows.map(r => `<option value="${r.doc._id}">${r.doc.unit_number} - ${r.doc.unit_type}</option>`).join('');
      document.getElementById('projectSelect').innerHTML = projectRes.rows.map(r => {
        projectMap[r.doc._id] = r.doc;
        return `<option value="${r.doc._id}" data-type="${r.doc.project_type}" data-property="${r.doc.property_type}">${r.doc.name}</option>`;
      }).join('');

      const primaryAgent = document.getElementById('primaryAgent');
      const secondaryAgent = document.getElementById('secondaryAgent');
      userRes.rows.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.doc.name;
        opt.textContent = r.doc.name;
        primaryAgent.appendChild(opt.cloneNode(true));
        secondaryAgent.appendChild(opt.cloneNode(true));
      });
    }

    document.getElementById('projectSelect').addEventListener('change', function () {
      const selected = this.options[this.selectedIndex];
      const id = selected.value;
      const proj = projectMap[id] || {};

      document.getElementById('projectType').value = proj.project_type || '';
      document.getElementById('propertyType').value = proj.property_type || '';
      document.getElementById('paymentTerm').value = proj.payment_term || '';
      document.getElementById('salePrice').value = proj.price || 0;
      document.getElementById('commission').value = proj.commission || 0;
      calculateFinalPrice();

      if (proj.project_type === 'Offplan' && proj.down_payment && proj.confirmation && proj.possession) {
        const fp = parseFloat(document.getElementById('finalPrice').value) || 0;
        const dp = (fp * proj.down_payment / 100).toFixed(0);
        const conf = (fp * proj.confirmation / 100).toFixed(0);
        const pos = (fp * proj.possession / 100).toFixed(0);
        document.getElementById('paymentBreakdown').innerHTML = `
          <b>Down Payment:</b> PKR ${dp}<br>
          <b>Confirmation:</b> PKR ${conf}<br>
          <b>Possession:</b> PKR ${pos}<br>
          <i>(Balloon/Installments calculated later based on payment term)</i>`;
        document.getElementById('paymentBreakdown').style.display = 'block';
      } else {
        document.getElementById('paymentBreakdown').style.display = 'none';
      }
    });

    function calculateFinalPrice() {
      const sale = parseFloat(document.getElementById('salePrice').value) || 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const final = sale - discount;
      document.getElementById('finalPrice').value = final >= 0 ? final : 0;
      document.getElementById('projectSelect').dispatchEvent(new Event('change'));
    }

    document.getElementById('discount').addEventListener('input', calculateFinalPrice);

    document.getElementById('dealForm').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const doc = {};
      formData.forEach((val, key) => doc[key] = val);
      doc._id = new Date().toISOString();
      await dbDeals.put(doc);
      e.target.reset();
      loadDeals();
    });

    async function loadDeals() {
      const res = await dbDeals.allDocs({ include_docs: true });
      const list = document.getElementById('dealsList');
      list.innerHTML = '';
      res.rows.forEach(row => {
        const d = row.doc;
        list.innerHTML += `
          <div class="form-card">
            <strong>${d.primary_agent}</strong> - ${d.unit_id}<br>
            <b>Commission:</b> PKR ${d.commission} | <b>Project:</b> ${d.project_id} | Status: ${d.status || 'open'}<br>
            <b>Final Price:</b> ${d.final_price || 'N/A'} | <b>Discount:</b> ${d.discount || '0'}<br>
            <button onclick="generateInvoice('${encodeURIComponent(JSON.stringify(d))}')">üßæ View Invoice</button>
          </div>`;
      });
    }

    async function generateInvoice(dealData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = JSON.parse(decodeURIComponent(dealData));

      doc.setFontSize(16);
      doc.text("üßæ Deal Invoice", 20, 20);

      doc.setFontSize(12);
      doc.text(`Deal ID: ${data._id}`, 20, 30);
      doc.text(`Lead ID: ${data.lead_id || 'N/A'}`, 20, 40);
      doc.text(`Project ID: ${data.project_id || 'N/A'}`, 20, 50);
      doc.text(`Unit ID: ${data.unit_id || 'N/A'}`, 20, 60);
      doc.text(`Agent: ${data.primary_agent}`, 20, 70);
      if (data.secondary_agent) doc.text(`Co-Agent: ${data.secondary_agent}`, 20, 80);
      doc.text(`Sale Price: PKR ${data.sale_price}`, 20, 90);
      doc.text(`Discount: PKR ${data.discount || 0}`, 20, 100);
      doc.text(`Final Price: PKR ${data.final_price}`, 20, 110);
      doc.text(`Commission: PKR ${data.commission}`, 20, 120);
      doc.text(`Affiliate: ${data.is_affiliate === 'yes' ? 'Yes' : 'No'}`, 20, 130);
      doc.text(`Status: ${data.status}`, 20, 140);
      if (data.notes) doc.text(`Notes: ${data.notes}`, 20, 150);

      doc.save(`Invoice_${data._id}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadOptions().then(loadDeals);
    });
  </script>
</body>
</html>
