<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CRM - Deals & Payments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #0d0d0d;
      color: white;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: #111;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid gold;
    }
    .navbar a {
      color: gold;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .container {
      padding: 20px;
    }
    .form-card, .deal-card {
      background: #1a1a1a;
      border: 1px solid gold;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.05);
    }
    h2, h3 {
      color: gold;
      border-bottom: 1px solid gold;
      padding-bottom: 5px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid gold;
      background: #1a1a1a;
      color: white;
    }
    button {
      background: linear-gradient(to right, #ffd700, #ffcc00);
      color: black;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="dashboard.html">Dashboard</a>
    <a href="leads.html">Leads</a>
    <a href="deals.html">Deals</a>
    <a href="projects_inventory.html">Inventory</a>
    <a href="sales_flow.html">Sales Flow</a>
    <a href="lead_status.html">Lead Status</a>
   <a href="settings.html">⚙️ Settings</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

 <div class="container">
    <div class="form-card">
      <h3>Create Deal</h3>
      <form id="dealForm">
        <label>Lead:</label>
        <select name="lead_id" id="leadSelect" required></select>

        <label>Unit:</label>
        <select name="unit_id" id="unitSelect" required></select>

        <label>Primary Agent:</label>
        <select name="primary_agent" id="primaryAgent" required></select>

        <label>Secondary Agent (optional):</label>
        <select name="secondary_agent" id="secondaryAgent"></select>

        <label>Is this an affiliate deal?</label>
        <select name="is_affiliate" id="isAffiliate">
          <option value="">No</option>
          <option value="yes">Yes</option>
        </select>

        <label>Sale Price:</label>
        <input type="number" name="sale_price" required />

        <label>Commission (Total):</label>
        <input type="number" name="commission" required />

        <label>Notes:</label>
        <textarea name="notes"></textarea>

        <button type="submit">Save Deal</button>
      </form>
    </div>

    <div class="form-card">
      <h3>Filter Deals</h3>
      <div class="filter-row">
        <select id="filterAgent"><option value="">All Agents</option></select>
        <input type="month" id="filterMonth" />
        <button onclick="loadDeals()">Apply</button>
      </div>
    </div>

    <div class="deal-card">
      <h3>All Deals</h3>
      <div id="dealsContainer"></div>
    </div>

    <div class="deal-card">
      <h3>Reports</h3>
      <canvas id="agentCommissionChart" height="120"></canvas>
      <canvas id="monthlyDealsChart" height="120"></canvas>
      <canvas id="avgDealSizeChart" height="120"></canvas>
      <canvas id="projectVolumeChart" height="120"></canvas>
    </div>
  </div>

  <script>
    const dbDeals = new PouchDB('crm_deals');
    const dbUsers = new PouchDB('crm_users');
    const dbUnits = new PouchDB('crm_inventory');

    async function loadOptions() {
      const userRes = await dbUsers.allDocs({ include_docs: true });
      userRes.rows.forEach(({ doc }) => {
        if (doc.role === 'sales_rep' || doc.role === 'manager') {
          ['primaryAgent', 'secondaryAgent', 'filterAgent'].forEach(id => {
            const opt = document.createElement('option');
            opt.value = doc.name;
            opt.textContent = doc.name;
            document.getElementById(id).appendChild(opt.cloneNode(true));
          });
        }
      });
    }

    document.getElementById('dealForm').onsubmit = async e => {
      e.preventDefault();
      const data = new FormData(e.target);
      const doc = {};
      data.forEach((val, key) => doc[key] = val);
      doc._id = new Date().toISOString();
      doc.created_at = new Date().toISOString();
      await dbDeals.put(doc);
      e.target.reset();
      loadDeals();
    };

    function calcCommissionBreakdown(doc) {
      const isAffiliate = doc.is_affiliate === 'yes';
      const commission = parseFloat(doc.commission || 0);
      const retained = isAffiliate ? (commission > 100000 ? 100000 : commission * 0.01) : commission;
      const companyShare = isAffiliate ? retained : commission;
      const sellerCount = doc.secondary_agent ? 2 : 1;
      const remaining = 4 - sellerCount;

      return {
        affiliate: isAffiliate ? commission - retained : 0,
        office: (companyShare * 0.20).toFixed(0),
        seller: (companyShare * 0.40 / sellerCount).toFixed(0),
        others: (companyShare * 0.40 / remaining).toFixed(0)
      };
    }

    async function loadDeals() {
      const agent = document.getElementById('filterAgent').value;
      const month = document.getElementById('filterMonth').value;

      const res = await dbDeals.allDocs({ include_docs: true });
      const container = document.getElementById('dealsContainer');
      container.innerHTML = '';

      let stats = { agents: {}, months: {}, projects: {}, deals: 0, total: 0 };

      for (const { doc } of res.rows) {
        const date = new Date(doc.created_at);
        const dealMonth = date.toISOString().slice(0, 7);

        if (agent && doc.primary_agent !== agent && doc.secondary_agent !== agent) continue;
        if (month && dealMonth !== month) continue;

        stats.deals++;
        const com = parseFloat(doc.commission || 0);
        stats.total += com;
        [doc.primary_agent, doc.secondary_agent].forEach(a => {
          if (a) stats.agents[a] = (stats.agents[a] || 0) + com / (doc.secondary_agent ? 2 : 1);
        });
        stats.months[dealMonth] = (stats.months[dealMonth] || 0) + 1;
        stats.projects[doc.unit_id?.split('-')[0] || 'Unknown'] = (stats.projects[doc.unit_id?.split('-')[0] || 'Unknown'] || 0) + 1;

        const breakdown = calcCommissionBreakdown(doc);
        container.innerHTML += `
          <div class="form-card">
            <strong>${doc.primary_agent}${doc.secondary_agent ? ' & ' + doc.secondary_agent : ''}</strong> sold <b>${doc.unit_id}</b><br>
            <b>Commission:</b> PKR ${doc.commission}<br>
            ${doc.is_affiliate === 'yes' ? `<b>Affiliate Share:</b> PKR ${breakdown.affiliate}<br>` : ''}
            <b>Office:</b> ${breakdown.office} | Seller: ${breakdown.seller} | Others: ${breakdown.others}
            <div><i>${doc.notes || ''}</i></div>
          </div>`;
      }

      drawCharts(stats);
    }

    function drawCharts(stats) {
      const agentLabels = Object.keys(stats.agents);
      const agentData = Object.values(stats.agents);

      const monthLabels = Object.keys(stats.months);
      const monthData = Object.values(stats.months);

      const avgData = agentLabels.map(a => (stats.agents[a] / (stats.deals / agentLabels.length)).toFixed(0));

      const projectLabels = Object.keys(stats.projects);
      const projectData = Object.values(stats.projects);

      new Chart(document.getElementById('agentCommissionChart'), {
        type: 'bar',
        data: { labels: agentLabels, datasets: [{ label: 'Commission PKR', data: agentData, backgroundColor: 'gold' }] },
        options: { plugins: { title: { display: true, text: 'Agent-wise Commission' } } }
      });

      new Chart(document.getElementById('monthlyDealsChart'), {
        type: 'bar',
        data: { labels: monthLabels, datasets: [{ label: 'Deals', data: monthData, backgroundColor: 'orange' }] },
        options: { plugins: { title: { display: true, text: 'Monthly Deal Volume' } } }
      });

      new Chart(document.getElementById('avgDealSizeChart'), {
        type: 'bar',
        data: { labels: agentLabels, datasets: [{ label: 'Avg Deal Size', data: avgData, backgroundColor: 'lime' }] },
        options: { plugins: { title: { display: true, text: 'Average Deal Size by Agent' } } }
      });

      new Chart(document.getElementById('projectVolumeChart'), {
        type: 'bar',
        data: { labels: projectLabels, datasets: [{ label: 'Deal Count', data: projectData, backgroundColor: 'teal' }] },
        options: { plugins: { title: { display: true, text: 'Deals per Project' } } }
      });
    }

    loadOptions().then(loadDeals);
  </script>
</body>
</html>
