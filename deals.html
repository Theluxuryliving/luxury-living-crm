<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #f8f8f8;
    margin: 0;
    color: #000;
  }
  .navbar {
    background: #000;
    padding: 15px;
    text-align: center;
    border-bottom: 1px solid #FFD700;
  }
  .navbar a {
    color: #FFD700;
    text-decoration: none;
    margin: 0 15px;
    font-weight: bold;
  }
  .container {
    padding: 20px;
  }
  .form-card, .deal-card {
    background: #fff;
    border: 1px solid #FFD700;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  h2, h3 {
    color: #000;
    border-bottom: 2px solid #FFD700;
    padding-bottom: 5px;
  }
  input, select, textarea {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    color: #000;
  }
  button {
    background: #000;
    color: #FFD700;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
    transition: transform 0.2s;
  }
  button:hover {
    transform: scale(1.05);
  }
  .breakdown-box {
    background: #f8f8f8;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    border: 1px dashed #FFD700;
  }
 .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stage-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      background: gold;
      color: black;
      font-weight: bold;
      font-size: 12px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="leads.html">üë• Leads</a>
    <a href="projects.html">üèóÔ∏è Projects</a>
    <a href="sales.html">üîÅ Sales Flow</a>
    <a href="documents.html">üìÅ Documents</a>
    <a href="reports.html">üìà Reports</a>
  </div>

  <div class="container">
    <div class="form-card">
      <h3>Create Deal</h3>
      <form id="dealForm">
        <label>Lead:</label>
        <select name="lead_id" id="leadSelect" required></select>

        <label>Project:</label>
        <select name="project_id" id="projectSelect" required></select>

        <label>Unit:</label>
        <select name="unit_id" id="unitSelect" required></select>

        <label>Project Type:</label>
        <input type="text" name="project_type" id="projectType" readonly />

        <label>Property Type:</label>
        <input type="text" name="property_type" id="propertyType" readonly />

        <label>Payment Term (months):</label>
        <input type="text" name="payment_term" id="paymentTerm" readonly />

        <label>Primary Agent:</label>
        <select name="primary_agent" id="primaryAgent" required></select>

        <label>Secondary Agent (optional):</label>
        <select name="secondary_agent" id="secondaryAgent"></select>

        <label>Is this an affiliate deal?</label>
        <select name="is_affiliate" id="isAffiliate">
          <option value="">No</option>
          <option value="yes">Yes</option>
        </select>

        <label>Sale Price:</label>
        <input type="number" name="sale_price" id="salePrice" readonly />

        <label>Discount:</label>
        <input type="number" name="discount" id="discount" value="0" />

        <label>Final Price:</label>
        <input type="number" name="final_price" id="finalPrice" readonly />

        <div class="breakdown-box" id="paymentBreakdown" style="display:none"></div>

        <label>Commission (Total):</label>
        <input type="number" name="commission" id="commission" readonly />

        <label>Status:</label>
        <select name="status" required>
          <option value="open">Open</option>
          <option value="closed-won">Closed - Won</option>
          <option value="closed-lost">Closed - Lost</option>
        </select>

        <label>Notes:</label>
        <textarea name="notes"></textarea>

        <button type="submit">Save Deal</button>
      </form>
    </div>

    <div class="deal-card">
      <h3>All Deals</h3>
      <div class="filter-bar">
        <select id="statusFilter">
          <option value="">All Statuses</option>
          <option value="open">Open</option>
          <option value="closed-won">Closed - Won</option>
          <option value="closed-lost">Closed - Lost</option>
        </select>
        <button onclick="loadDeals()">Apply Filter</button>
      </div>
      <div id="dealsList"></div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
<script>
  const dbDeals = new PouchDB('crm_deals');
  const dbLeads = new PouchDB('crm_leads');
  const dbInventory = new PouchDB('crm_inventory');
  const dbProjects = new PouchDB('crm_projects');
  const dbUsers = new PouchDB('crm_users');
  let projectMap = {};

  async function loadOptions() {
    const [leadRes, unitRes, userRes, projectRes] = await Promise.all([
      dbLeads.allDocs({ include_docs: true }),
      dbInventory.allDocs({ include_docs: true }),
      dbUsers.allDocs({ include_docs: true }),
      dbProjects.allDocs({ include_docs: true })
    ]);

    document.getElementById('leadSelect').innerHTML = leadRes.rows.map(r => `<option value="${r.doc._id}">${r.doc.Name}</option>`).join('');
    document.getElementById('unitSelect').innerHTML = unitRes.rows.map(r => `<option value="${r.doc._id}">${r.doc.unit_number} - ${r.doc.unit_type}</option>`).join('');
    document.getElementById('projectSelect').innerHTML = projectRes.rows.map(r => {
      projectMap[r.doc._id] = r.doc;
      return `<option value="${r.doc._id}">${r.doc.name}</option>`;
    }).join('');

    const primaryAgent = document.getElementById('primaryAgent');
    const secondaryAgent = document.getElementById('secondaryAgent');
    userRes.rows.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.doc.name;
      opt.textContent = r.doc.name;
      primaryAgent.appendChild(opt.cloneNode(true));
      secondaryAgent.appendChild(opt.cloneNode(true));
    });
  }

  function calculateFinalPrice() {
    const sale = parseFloat(document.getElementById('salePrice').value) || 0;
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const final = sale - discount;
    document.getElementById('finalPrice').value = final >= 0 ? final : 0;
    document.getElementById('projectSelect').dispatchEvent(new Event('change'));
  }

  document.getElementById('projectSelect').addEventListener('change', function () {
    const selected = this.options[this.selectedIndex];
    const id = selected.value;
    const proj = projectMap[id] || {};

    document.getElementById('projectType').value = proj.project_type || '';
    document.getElementById('propertyType').value = proj.property_type || '';
    document.getElementById('paymentTerm').value = proj.payment_term || '';
    document.getElementById('salePrice').value = proj.price || 0;
    document.getElementById('commission').value = proj.commission || 0;
    calculateFinalPrice();

    if (proj.project_type === 'Offplan' && proj.down_payment && proj.confirmation && proj.possession) {
      const fp = parseFloat(document.getElementById('finalPrice').value) || 0;
      const dp = (fp * proj.down_payment / 100).toFixed(0);
      const conf = (fp * proj.confirmation / 100).toFixed(0);
      const pos = (fp * proj.possession / 100).toFixed(0);
      document.getElementById('paymentBreakdown').innerHTML = `
        <b>Down Payment:</b> PKR ${dp}<br>
        <b>Confirmation:</b> PKR ${conf}<br>
        <b>Possession:</b> PKR ${pos}<br>
        <i>(Balloon/Installments calculated later based on payment term)</i>`;
      document.getElementById('paymentBreakdown').style.display = 'block';
    } else {
      document.getElementById('paymentBreakdown').style.display = 'none';
    }
  });

  document.getElementById('discount').addEventListener('input', calculateFinalPrice);

  document.getElementById('dealForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const doc = {};
    formData.forEach((val, key) => doc[key] = val);
    doc._id = new Date().toISOString();
    await dbDeals.put(doc);

    try {
      await fetch('/.netlify/functions/insert_deal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(doc)
      });
    } catch (err) {
      console.error("Sync to Neon failed", err);
    }

    e.target.reset();
    loadDeals();
  });

  async function loadDeals() {
    const statusFilter = document.getElementById('statusFilter').value;
    const res = await dbDeals.allDocs({ include_docs: true });
    const list = document.getElementById('dealsList');
    list.innerHTML = '';
    res.rows.forEach(row => {
      const d = row.doc;
      if (statusFilter && d.status !== statusFilter) return;

      list.innerHTML += `
        <div class="form-card">
          <strong>${d.primary_agent}</strong> - ${d.unit_id}<br>
          <b>Commission:</b> PKR ${d.commission} | <b>Project:</b> ${d.project_id} | 
          <b>Status:</b> ${d.status || 'open'}<span class="stage-badge">${d.status}</span><br>
          <b>Final Price:</b> ${d.final_price || 'N/A'} | <b>Discount:</b> ${d.discount || '0'}
        </div>`;
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadOptions().then(loadDeals);
  });
</script>

  </body>
</html>

    document.addEventListener('DOMContentLoaded', () => {
  loadOptions().then(loadDeals);
});
  </script>
</body>
</html>
