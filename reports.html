<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #f4f6f9;
    }
    nav {
      background: #1b1f3b;
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
    }
    nav h1 {
      flex: 1;
      font-size: 20px;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      font-weight: 500;
    }
    .tab {
      margin: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .kpi {
      display: inline-block;
      margin-right: 20px;
      background: #eef2f7;
      padding: 10px 15px;
      border-radius: 8px;
      min-width: 150px;
      text-align: center;
    }
    .kpi span {
      display: block;
      font-size: 13px;
      color: #555;
    }
    .kpi strong {
      font-size: 22px;
      color: #1b1f3b;
    }
    canvas { max-width: 600px; margin-top: 20px; }
    select, input[type="text"] {
      margin-right: 10px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<nav>
  <h1>Luxury Living CRM</h1>
  <a href="dashboard.html">Dashboard</a>
  <a href="leads.html">Leads</a>
  <a href="projects.html">Projects</a>
  <a href="calendar.html">Calendar</a>
  <a href="reports.html">Reports</a>
</nav>

<div class="tab" id="leads">
  <h3>Leads Report</h3>
  <input type="text" id="leads-date" placeholder="YYYY-MM-DD to YYYY-MM-DD">
  <select id="leads-agent" multiple>
    <option value="Atif Zubair">Atif Zubair</option>
    <option value="Atif Aziz">Atif Aziz</option>
    <option value="Talha Ali">Talha Ali</option>
    <option value="Talal Younas">Talal Younas</option>
  </select>
  <select id="leads-project">
    <option value="">All Projects</option>
    <option value="Royal Residencia">Royal Residencia</option>
    <option value="Etihad Town">Etihad Town</option>
  </select>
  <select id="leads-source">
    <option value="">All Sources</option>
    <option value="Facebook">Facebook</option>
    <option value="Walk-in">Walk-in</option>
  </select>

  <div class="kpi"><span>Total Leads</span><strong>0</strong></div>
  <div class="kpi"><span>Matured Leads</span><strong>0</strong></div>
  <div class="kpi"><span>Conversion %</span><strong>0%</strong></div>

  <table id="leadsTable" class="display" width="100%">
    <thead>
      <tr>
        <th>Name</th>
        <th>Status</th>
        <th>Agent</th>
        <th>Project</th>
        <th>Date</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <canvas id="leadsChart" height="150"></canvas>
</div>

<hr />

<div class="tab" id="revenue">
  <h3>Revenue Report</h3>
  <input type="text" id="revenue-date" placeholder="YYYY-MM-DD to YYYY-MM-DD">
  <select id="revenue-agent">
    <option value="">All Agents</option>
    <option value="Talha Ali">Talha Ali</option>
    <option value="Talal Younas">Talal Younas</option>
  </select>
  <select id="revenue-project">
    <option value="">All Projects</option>
    <option value="Royal Residencia">Royal Residencia</option>
    <option value="Etihad Town">Etihad Town</option>
  </select>
  <label><input type="checkbox" id="revenue-compare" /> Compare with previous period</label>

  <div class="kpi"><span>Total Revenue</span><strong>Rs 0</strong></div>
  <div class="kpi"><span>Previous Period</span><strong>Rs 0</strong></div>

   <canvas id="revenueChart" height="150"></canvas>
</div>

<!-- JS Section -->
<script>
function loadLeadReport() {
  const date = $('#leads-date').val();
  const agents = $('#leads-agent').val() || [];
  const project = $('#leads-project').val();
  const source = $('#leads-source').val();

  const url = `https://luxurylivingcrm.42web.io/get_lead_report_data.php?date=${date}&agents=${agents.join(',')}&project=${project}&source=${source}`;

  fetch(url)
    .then(res => res.json())
    .then(res => {
      const table = $('#leadsTable').DataTable();
      table.clear();
      const statusCounts = {};
      res.data.forEach(row => {
        table.row.add([row.name, row.lead_status, row.agent_name, row.project_name, row.lead_date, row.lead_source]);
        statusCounts[row.lead_status] = (statusCounts[row.lead_status] || 0) + 1;
      });
      table.draw();
      document.querySelector('#leads .kpi:nth-child(1) strong').textContent = res.total;
      document.querySelector('#leads .kpi:nth-child(2) strong').textContent = res.matured;
      document.querySelector('#leads .kpi:nth-child(3) strong').textContent = `${res.conversion}%`;
      renderLeadChart(statusCounts);
    });
}

function renderLeadChart(counts) {
  const ctx = document.getElementById('leadsChart').getContext('2d');
  if (window.leadsChart) window.leadsChart.destroy();
  window.leadsChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        data: Object.values(counts),
        backgroundColor: ['#36A2EB', '#4BC0C0', '#FF6384', '#FFCE56', '#9966FF']
      }]
    },
    options: { responsive: true }
  });
}

function loadRevenueReport() {
  const date = $('#revenue-date').val();
  const agent = $('#revenue-agent').val();
  const project = $('#revenue-project').val();
  const compare = $('#revenue-compare').prop('checked') ? 1 : 0;

  fetch(`https://luxurylivingcrm.42web.io/get_revenue_report_data.php?agent=${agent}&project=${project}&date=${date}&compare=${compare}`)
    .then(res => res.json())
    .then(res => {
      document.querySelector('#revenue .kpi:nth-child(1) strong').textContent = 'Rs ' + res.revenue.toLocaleString();
      document.querySelector('#revenue .kpi:nth-child(2) strong').textContent = 'Rs ' + res.prev_revenue.toLocaleString();
      renderRevenueChart(res.revenue, res.prev_revenue);
    });
}

function renderRevenueChart(current, previous) {
  const ctx = document.getElementById('revenueChart').getContext('2d');
  if (window.revenueChart) window.revenueChart.destroy();
  window.revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Current Period', 'Previous Period'],
      datasets: [{
        label: 'Revenue',
        data: [current, previous],
        backgroundColor: ['#36A2EB', '#FFCE56']
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// Event listeners
$('#leads-date, #leads-agent, #leads-project, #leads-source').on('change', loadLeadReport);
$('#revenue-date, #revenue-agent, #revenue-project, #revenue-compare').on('change', loadRevenueReport);

$(document).ready(() => {
  $('#leadsTable').DataTable();
  loadLeadReport();
  loadRevenueReport();
});

// Role restriction check
fetch('https://luxurylivingcrm.42web.io/get_user_role.php')
  .then(res => res.json())
  .then(data => {
    if (!['admin', 'manager'].includes(data.role)) {
      document.body.innerHTML = '<h2 style="color:red;text-align:center;margin-top:50px">Access Denied</h2>';
    }
  });
</script>

</body>
</html>

