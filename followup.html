<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM - Follow-ups</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d;
      color: white;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: #111;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid gold;
    }
    .navbar a {
      color: gold;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .followups-container {
      max-width: 1000px;
      margin: 30px auto;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid gold;
    }
    .followup-entry {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #444;
    }
    .followup-entry h4 {
      margin: 0;
      color: gold;
    }
    .followup-entry small {
      color: #ccc;
    }
    .modal {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a1a;
      padding: 20px;
      border: 2px solid gold;
      border-radius: 10px;
      z-index: 999;
      width: 90%;
      max-width: 500px;
      color: white;
    }
    .modal input, .modal select, .modal textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: #111;
      color: white;
      border: 1px solid gold;
      border-radius: 6px;
    }
    .modal button {
      background: gold;
      color: black;
      border: none;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn { margin: 10px; padding: 10px 15px; font-weight: bold; border-radius: 6px; background: gold; color: black; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="dashboard.html">Dashboard</a>
    <a href="calendar.html">üìÖ Calendar</a>
    <a href="followups.html">üìù Follow-ups</a>
    <a href="settings.html">‚öô Settings</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <div class="followups-container">
    <button class="btn" onclick="openModal()">‚ûï Add Follow-up</button>
    <div id="followupList"></div>
  </div>

  <!-- Modal Form -->
  <div class="modal" id="followupModal">
    <h3 id="modalTitle">Add/Edit Follow-up</h3>
    <input type="hidden" id="followupId">
    <label>Lead Name</label>
    <input type="text" id="leadName">
    <label>Type</label>
    <select id="type">
      <option>Call</option>
      <option>Meeting</option>
      <option>WhatsApp</option>
      <option>Email</option>
    </select>
    <label>Date</label>
    <input type="date" id="date">
    <label>Follow-up Date</label>
    <input type="date" id="followUpDate">
    <label>Status</label>
    <select id="status">
      <option value="pending">Pending</option>
      <option value="done">Done</option>
    </select>
    <label>Notes</label>
    <textarea id="notes" rows="4"></textarea>
    <button onclick="saveFollowup()">üíæ Save</button>
    <button onclick="deleteFollowup()" style="background:red; color:white;">üóë Delete</button>
  </div>

  <script>
    const db = new PouchDB("crm_activities");
    const user = localStorage.getItem("repName") || "Unknown";
    const role = localStorage.getItem("role") || "sales_rep";

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    function openModal(data = {}) {
      document.getElementById("followupId").value = data._id || "";
      document.getElementById("leadName").value = data.leadName || "";
      document.getElementById("type").value = data.type || "Call";
      document.getElementById("date").value = data.date || new Date().toISOString().substr(0, 10);
      document.getElementById("followUpDate").value = data.followUpDate || new Date().toISOString().substr(0, 10);
      document.getElementById("status").value = data.status || "pending";
      document.getElementById("notes").value = data.notes || "";
      document.getElementById("followupModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("followupModal").style.display = "none";
    }

    async function saveFollowup() {
      const doc = {
        _id: document.getElementById("followupId").value || new Date().toISOString(),
        agent: user,
        leadName: document.getElementById("leadName").value,
        type: document.getElementById("type").value,
        date: document.getElementById("date").value,
        followUpDate: document.getElementById("followUpDate").value,
        status: document.getElementById("status").value,
        notes: document.getElementById("notes").value,
      };
      try {
        const existing = await db.get(doc._id);
        doc._rev = existing._rev;
      } catch {}
      await db.put(doc);
      closeModal();
      loadFollowups();
    }

    async function deleteFollowup() {
      const id = document.getElementById("followupId").value;
      if (!id) return;
      const doc = await db.get(id);
      await db.remove(doc);
      closeModal();
      loadFollowups();
    }

    async function loadFollowups() {
      const result = await db.allDocs({ include_docs: true });
      const followups = result.rows.map(r => r.doc).filter(f => role === 'admin' || role === 'manager' || f.agent === user);
      const container = document.getElementById("followupList");
      container.innerHTML = followups.map(f => `
        <div class="followup-entry">
          <h4>${f.leadName} (${f.type})</h4>
          <small>üìÖ Date: ${f.date} | üìå Follow-up: ${f.followUpDate} | ‚úÖ Status: ${f.status}</small>
          <p>${f.notes || "No notes"}</p>
          <button class="btn" onclick='openModal(${JSON.stringify(f)})'>‚úèÔ∏è Edit</button>
        </div>
      `).join('');
    }

    loadFollowups();
  </script>
</body>
</html>
