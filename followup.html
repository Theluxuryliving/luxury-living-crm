<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Dashboard - Follow-ups</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0d0d0d; color: white; margin: 0; padding: 0; }
    .tab-header { display: flex; justify-content: center; gap: 20px; background: #111; padding: 15px; border-bottom: 1px solid gold; }
    .tab-header button { background: #222; color: gold; border: 1px solid gold; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .tab-header button.active { background: gold; color: black; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }

    .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .filters select, .filters input { padding: 10px; background: #1a1a1a; color: white; border: 1px solid gold; border-radius: 5px; }

    .followup-list { display: flex; flex-direction: column; gap: 10px; }
    .followup-item { background: #1a1a1a; border: 1px solid gold; padding: 15px; border-radius: 8px; position: relative; }
    .followup-item.overdue { border-left: 5px solid red; }
    .followup-item.due-today { border-left: 5px solid orange; }

    .edit-btn { position: absolute; top: 10px; right: 10px; background: gold; color: black; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <div class="tab-header">
    <button class="active" onclick="switchTab('followupTab')">üìù Follow-ups</button>
    <button onclick="location.href='calendar.html'">üìÖ Calendar</button>
  </div>

  <div id="followupTab" class="tab-content active">
    <div class="filters">
      <select id="filterStatus"><option value="">All Status</option><option value="pending">Pending</option><option value="done">Done</option></select>
      <select id="filterAgent"><option value="">All Agents</option></select>
      <input type="date" id="filterDate" />
      <button onclick="loadFollowups()">Apply Filters</button>
    </div>

    <div class="followup-list" id="followupList"></div>
  </div>

  <script>
    const db = new PouchDB("crm_activities");
    const user = localStorage.getItem("repName") || "Unknown";
    const role = localStorage.getItem("role") || "sales_rep";

    function switchTab(id) {
      document.querySelectorAll(".tab-content").forEach(div => div.classList.remove("active"));
      document.querySelectorAll(".tab-header button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      event.target.classList.add("active");
    }

    async function loadFollowups() {
      const status = document.getElementById("filterStatus").value;
      const agent = document.getElementById("filterAgent").value;
      const date = document.getElementById("filterDate").value;
      const now = new Date().toISOString().split("T")[0];

      const result = await db.allDocs({ include_docs: true });
      const docs = result.rows.map(r => r.doc).filter(doc => {
        return (!status || doc.status === status) &&
               (!agent || doc.agent === agent) &&
               (!date || doc.date === date) &&
               (role === 'admin' || role === 'manager' || doc.agent === user);
      });

      const agents = [...new Set(result.rows.map(r => r.doc.agent))];
      const agentSel = document.getElementById("filterAgent");
      agentSel.innerHTML = '<option value="">All Agents</option>' + agents.map(a => `<option value="${a}">${a}</option>`).join('');

      const list = document.getElementById("followupList");
      list.innerHTML = docs.map(doc => {
        const overdue = doc.date < now && doc.status !== 'done';
        const dueToday = doc.date === now && doc.status !== 'done';
        const classList = ["followup-item"];
        if (overdue) classList.push("overdue");
        else if (dueToday) classList.push("due-today");
        return `
          <div class="${classList.join(' ')}">
            <strong>${doc.leadName}</strong> | ${doc.type} | ${doc.date}<br>
            Status: ${doc.status} | Follow-up: ${doc.followUpDate}<br>
            Notes: ${doc.notes}<br>
            <button class="edit-btn" onclick='editActivity(${JSON.stringify(doc)})'>‚úèÔ∏è Edit</button>
          </div>
        `;
      }).join('');
    }

    function editActivity(doc) {
      localStorage.setItem("activityEdit", JSON.stringify(doc));
      window.location.href = "calendar.html";
    }

    loadFollowups();
  </script>
</body>
</html>
