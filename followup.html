<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Follow-ups</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0d0d0d; color: white; margin: 0; padding: 0; }
    .navbar { background: #111; padding: 15px; text-align: center; border-bottom: 1px solid gold; }
    .navbar a { color: gold; text-decoration: none; margin: 0 15px; font-weight: bold; }
    .filter-bar, .followup-form, .followup-list { max-width: 900px; margin: 20px auto; padding: 20px; background: #1a1a1a; border-radius: 10px; border: 1px solid gold; }
    input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid gold; border-radius: 6px; background: #111; color: white; }
    button { background: gold; color: black; font-weight: bold; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    .followup-item { background: #222; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 5px solid gold; }
    .overdue { border-left-color: red; }
    .due-today { border-left-color: orange; }
  </style>
</head>
<body>
  <div class="filter-bar">
    <h3>Filter Follow-ups</h3>
    <select id="filterStatus">
      <option value="">All Statuses</option>
      <option value="pending">Pending</option>
      <option value="done">Done</option>
    </select>
    <select id="filterAgent"></select>
    <input type="date" id="filterDate" />
    <button onclick="loadFollowups()">Apply</button>
  </div>

  <div class="followup-form">
    <h3>Add/Edit Follow-up</h3>
    <input type="hidden" id="followupId">
    <select id="leadDropdown"></select>
    <select id="type">
      <option>Call</option>
      <option>Meeting</option>
      <option>WhatsApp</option>
      <option>Email</option>
    </select>
    <input type="date" id="date">
    <input type="date" id="followUpDate">
    <select id="status">
      <option value="pending">Pending</option>
      <option value="done">Done</option>
    </select>
    <textarea id="notes" placeholder="Notes"></textarea>
    <button onclick="saveFollowup()">ðŸ’¾ Save</button>
  </div>

  <div class="followup-list">
    <h3>Follow-up Activities</h3>
    <div id="followupContainer"></div>
  </div>

  <script>
    const db = new PouchDB("crm_activities");
    const leadsDb = new PouchDB("crm_leads");
    const user = localStorage.getItem("repName") || "Unknown";
    const role = localStorage.getItem("role") || "sales_rep";

    async function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    async function loadLeads() {
      const res = await leadsDb.allDocs({ include_docs: true });
      const dropdown = document.getElementById("leadDropdown");
      dropdown.innerHTML = res.rows.map(r => `<option value="${r.doc._id}">${r.doc.Name} (${r.doc.Phone})</option>`).join('');
    }

    async function saveFollowup() {
      const id = document.getElementById("followupId").value || new Date().toISOString();
      const doc = {
        _id: id,
        agent: user,
        leadId: document.getElementById("leadDropdown").value,
        leadName: document.getElementById("leadDropdown").selectedOptions[0].textContent,
        type: document.getElementById("type").value,
        date: document.getElementById("date").value,
        followUpDate: document.getElementById("followUpDate").value,
        status: document.getElementById("status").value,
        notes: document.getElementById("notes").value,
      };
      try {
        const existing = await db.get(id);
        doc._rev = existing._rev;
      } catch {}
      await db.put(doc);
      loadFollowups();
    }

    async function loadFollowups() {
      const res = await db.allDocs({ include_docs: true });
      const selectedStatus = document.getElementById("filterStatus").value;
      const selectedAgent = document.getElementById("filterAgent").value;
      const selectedDate = document.getElementById("filterDate").value;
      const today = new Date().toISOString().split('T')[0];

      const filtered = res.rows.map(r => r.doc).filter(doc => {
        return (!selectedStatus || doc.status === selectedStatus) &&
               (!selectedAgent || doc.agent === selectedAgent) &&
               (!selectedDate || doc.date === selectedDate) &&
               (role === 'admin' || role === 'manager' || doc.agent === user);
      });

      const container = document.getElementById("followupContainer");
      container.innerHTML = filtered.map(doc => {
        let classes = "followup-item";
        if (doc.followUpDate < today && doc.status === 'pending') classes += " overdue";
        else if (doc.followUpDate === today && doc.status === 'pending') classes += " due-today";
        return `<div class="${classes}" onclick="editFollowup('${doc._id}')">
          <strong>${doc.leadName}</strong> (${doc.type})<br>
          Date: ${doc.date} | Follow-up: ${doc.followUpDate}<br>
          Status: ${doc.status} | Agent: ${doc.agent}<br>
          ${doc.notes || ''}
        </div>`;
      }).join('');

      // populate filter dropdown
      const agents = [...new Set(res.rows.map(r => r.doc.agent))];
      document.getElementById("filterAgent").innerHTML = '<option value="">All Agents</option>' + agents.map(a => `<option>${a}</option>`).join('');
    }

    async function editFollowup(id) {
      const doc = await db.get(id);
      document.getElementById("followupId").value = doc._id;
      document.getElementById("leadDropdown").value = doc.leadId;
      document.getElementById("type").value = doc.type;
      document.getElementById("date").value = doc.date;
      document.getElementById("followUpDate").value = doc.followUpDate;
      document.getElementById("status").value = doc.status;
      document.getElementById("notes").value = doc.notes;
    }

    loadLeads();
    loadFollowups();
  </script>
</body>
</html>
