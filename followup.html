<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Follow-ups</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0d0d0d; color: white; margin: 0; padding: 0; }
    .navbar { background: #111; padding: 15px; text-align: center; border-bottom: 1px solid gold; }
    .navbar a { color: gold; text-decoration: none; margin: 0 15px; font-weight: bold; }
    .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
    .filters { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .filters select, .filters input { padding: 8px; background: #1a1a1a; color: white; border: 1px solid gold; border-radius: 6px; }
    .followup-card { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
    .followup-card.overdue { border: 1px solid red; }
    .followup-card.due-today { border: 1px solid gold; }
    .followup-card h4 { margin: 0 0 10px; color: gold; }
    .followup-card small { display: block; color: #bbb; }
  </style>
</head>
<body>
<div class="navbar">
 <a href="dashboard.html">Dashboard</a>
 <a href="leads.html">Leads</a>
 <a href="form.html">‚ûï Add New Client</a>
 <a href="Projects_inventory.html">Inventory</a>
 <a href="Deals.html">Deals</a>
 <a href="Sales_Flow.html">Sales Flow</a>
 <a href="Lead_status.html">Leads Status</a>
 <a href="calendar.html">üìÖ Calendar</a>
 <a href="followup.html">üìù Follow-ups</a>
 <a href="settings.html">‚öô Settings</a>
 <a href="#" onclick="logout()">Logout</a>
</div>

<div class="container">
  <div class="filters">
    <select id="statusFilter">
      <option value="">All Statuses</option>
      <option value="pending">Pending</option>
      <option value="done">Done</option>
    </select>
    <input type="date" id="dateFilter" />
    <select id="agentFilter"></select>
    <button onclick="loadFollowups()">Apply</button>
  </div>
  <div id="followupList"></div>
</div>

<script>
  const db = new PouchDB('crm_activities');
  const user = localStorage.getItem('repName') || 'Unknown';
  const role = localStorage.getItem('role') || 'sales_rep';

  function logout() {
    localStorage.clear();
    window.location.href = 'index.html';
  }

  async function loadFollowups() {
    const status = document.getElementById('statusFilter').value;
    const date = document.getElementById('dateFilter').value;
    const agent = document.getElementById('agentFilter').value;
    const today = new Date().toISOString().substr(0,10);

    const result = await db.allDocs({ include_docs: true });
    const docs = result.rows.map(r => r.doc).filter(doc => {
      return (role === 'admin' || role === 'manager' || doc.agent === user) &&
             (!status || doc.status === status) &&
             (!date || doc.followUpDate === date) &&
             (!agent || doc.agent === agent);
    });

    const list = document.getElementById('followupList');
    list.innerHTML = docs.map(doc => {
      const isOverdue = doc.status === 'pending' && doc.followUpDate < today;
      const isToday = doc.status === 'pending' && doc.followUpDate === today;
      const cls = isOverdue ? 'overdue' : isToday ? 'due-today' : '';
      return `
        <div class="followup-card ${cls}">
          <h4>${doc.type} with ${doc.leadName}</h4>
          <small>Agent: ${doc.agent}</small>
          <small>Date: ${doc.date}</small>
          <small>Follow-up: ${doc.followUpDate}</small>
          <small>Status: ${doc.status}</small>
          <small>Notes: ${doc.notes}</small>
        </div>
      `;
    }).join('');
  }

  async function populateAgentFilter() {
    const result = await db.allDocs({ include_docs: true });
    const agents = [...new Set(result.rows.map(r => r.doc.agent).filter(Boolean))];
    const sel = document.getElementById('agentFilter');
    sel.innerHTML = `<option value="">All Agents</option>` + agents.map(a => `<option>${a}</option>`).join('');
  }

  populateAgentFilter().then(loadFollowups);
</script>
</body>
</html>
