<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Follow-ups</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0d0d0d; color: white; margin: 0; padding: 0; }
    .navbar { background: #111; padding: 15px; text-align: center; border-bottom: 1px solid gold; }
    .navbar a { color: gold; text-decoration: none; margin: 0 15px; font-weight: bold; }
    .filter-bar, .followup-list { max-width: 1200px; margin: 20px auto; padding: 20px; background: #1a1a1a; border-radius: 10px; border: 1px solid gold; }
    .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, input[type="date"] { padding: 10px; border-radius: 6px; border: 1px solid gold; background: #111; color: white; min-width: 200px; }
    button { background: gold; color: black; font-weight: bold; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    .followup-item { background: #222; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 5px solid gold; cursor: pointer; }
    .overdue { border-left-color: red; }
    .due-today { border-left-color: orange; }
    .followup-detail { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
    .followup-detail textarea, .followup-detail input, .followup-detail select {
      width: 100%; padding: 8px; border-radius: 4px; border: 1px solid gold; background: #111; color: white;
    }
  </style>
</head>
<body>
  <div class="filter-bar">
    <h3>Filter Follow-ups</h3>
    <div class="filter-row">
      <select id="filterStatus">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="done">Done</option>
      </select>
      <select id="filterAgent"></select>
      <input type="date" id="filterDate" />
      <button onclick="loadFollowups()">Apply</button>
    </div>
  </div>

  <div class="followup-list">
    <h3>Follow-up Activities</h3>
    <div id="followupContainer"></div>
    <div style="padding-top: 10px; font-weight: bold;">
      Summary: Pending - <span id="pendingCount">0</span>, Done - <span id="doneCount">0</span>, Overdue - <span id="overdueCount">0</span>
    </div>
    <div id="agentOverdueSummary" style="margin-top: 15px; padding: 10px; background: #111; border-radius: 8px; color: gold; font-size: 14px;"></div>
  </div>
<script>
    const db = new PouchDB("crm_activities");
    const leadsDb = new PouchDB("crm_leads");
    const calendarDB = new PouchDB("crm_calendar");
    const user = localStorage.getItem("repName") || "Unknown";
    const role = localStorage.getItem("role") || "sales_rep";

    async function loadFollowups() {
      const res = await leadsDb.allDocs({ include_docs: true });
      const allLeads = res.rows.map(r => r.doc);
      const activitiesRes = await db.allDocs({ include_docs: true });
      const activities = activitiesRes.rows.map(r => r.doc);

      const selectedStatus = document.getElementById("filterStatus").value;
      const selectedAgent = document.getElementById("filterAgent").value;
      const selectedDate = document.getElementById("filterDate").value;
      const today = new Date().toISOString().split('T')[0];

      const container = document.getElementById("followupContainer");
      container.innerHTML = allLeads.map(lead => {
        const showOverdueOnly = document.getElementById("showOverdueOnly")?.checked;

        const leadActivities = activities.filter(a => a.leadId === lead._id);
        const latest = leadActivities.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        const noActivity = !latest;

        if (selectedAgent && lead.assigned_to !== selectedAgent) return '';

        const showOverdueOnly = document.getElementById("showOverdueOnly")?.checked;
        if (showOverdueOnly) {
          if (!latest || latest.status !== 'pending' || !latest.followUpDate || latest.followUpDate >= today) return '';
        }

        if (selectedStatus && (!latest || latest.status !== selectedStatus)) return '';

        if (selectedDate && (!latest || latest.followUpDate !== selectedDate)) return '';
        if (showOverdueOnly && (!latest || latest.status !== 'pending' || latest.followUpDate >= today)) return '';
        if (selectedStatus && (!latest || latest.status !== selectedStatus)) return '';
        if (selectedDate && (!latest || latest.date !== selectedDate)) return '';
        // Agent filter temporarily bypassed for debug
// if ((role !== 'admin' && role !== 'manager') && lead.assigned_to !== user) return '';

        const overdue = latest && latest.status === 'pending' && latest.followUpDate < today;
        const dueToday = latest && latest.status === 'pending' && latest.followUpDate === today;
        const needsAttention = noActivity || overdue;
        let statusClass = '';
        if (noActivity) statusClass = 'overdue';$1return `
          <div class="followup-item ${statusClass}">
            <strong>${lead.Name}</strong> (${lead.Phone})<br>
            ${noActivity ? '<em style="color: orange">No follow-up activity yet</em><br>' : ''}
            Assigned to: ${lead.assigned_to || 'Unassigned'}<br>
            <div class="followup-detail">
              <select onchange="updateActivity('${lead._id}', 'type', this.value)">
                <option value="Call">Call</option>
                <option value="Meeting">Meeting</option>
                <option value="WhatsApp">WhatsApp</option>
                <option value="Email">Email</option>
              </select>
              <input type="date" onchange="updateActivity('${lead._id}', 'date', this.value)" />
              <input type="date" onchange="updateActivity('${lead._id}', 'followUpDate', this.value)" />
              <select onchange="updateActivity('${lead._id}', 'status', this.value)">
                <option value="pending">Pending</option>
                <option value="done">Done</option>
              </select>
              <textarea placeholder="Conversation notes" onchange="updateActivity('${lead._id}', 'notes', this.value)"></textarea>
            </div>
          </div>
        `;
      }).join('');

      const agents = [...new Set(allLeads.map(l => l.assigned_to).filter(Boolean))];
      const agentFilter = document.getElementById("filterAgent");
      agentFilter.innerHTML = '<option value="">All Agents</option>' + agents.map(a => `<option value="${a}">${a}</option>`).join('');

// Add custom overdue-only checkbox
if (!document.getElementById("showOverdueOnly")) {
  const overdueCheckbox = document.createElement("label");
  overdueCheckbox.innerHTML = '<input type="checkbox" id="showOverdueOnly"> Overdue Only';
  document.querySelector(".filter-row").appendChild(overdueCheckbox);
}
    }

    async function updateActivity(leadId, field, value) {
      const today = new Date().toISOString().split('T')[0];
      const id = `${leadId}-${today}`;
      let doc;
      try { doc = await db.get(id); } catch { doc = { _id: id, leadId, agent: user }; }
      doc[field] = value;
      doc.date = doc.date || today;
      await db.put(doc);

      await calendarDB.put({
        _id: `cal-${id}`,
        title: `Follow-up: ${field} updated`,
        start: today,
        agent: user,
        description: `${field} changed to ${value} for lead ${leadId}`
      }).catch(err => {});

      window.parent.postMessage({
  type: "crm-notification",
  source: "Follow-ups",
  message: `Updated ${field}, "*");

if (window.top !== window && typeof window.top.addNotification === 'function') {
  window.top.addNotification(`Follow-up updated: ${field} set to ${value}`, user);
}

      const agentStats = {};
      allLeads.forEach(lead => {
        const acts = activities.filter(a => a.leadId === lead._id);
        const latest = acts.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        const assigned = lead.assigned_to || 'Unassigned';
        if (!agentStats[assigned]) agentStats[assigned] = { total: 0, overdue: 0 };
        agentStats[assigned].total++;
        const today = new Date().toISOString().split('T')[0];
        if (!latest || (latest.status === 'pending' && latest.followUpDate < today)) agentStats[assigned].overdue++;
      });

      const summaryDiv = document.getElementById("agentOverdueSummary");
      summaryDiv.innerHTML = Object.entries(agentStats).map(([agent, stat]) => {
        const percent = stat.total ? ((stat.overdue / stat.total) * 100).toFixed(1) : '0';
        if (percent >= 50) {
          sendNotificationToDashboard("Follow-ups", `${agent} has ${percent}% overdue follow-ups`, agent);
        }
        const highlight = percent >= 50 ? ' style="color: red; font-weight: bold;"' : '';
        return `<div${highlight}>${agent}: ${percent}% overdue (${stat.overdue}/${stat.total})</div>`;
      }).join("<br>");

      loadFollowups();

function sendNotificationToDashboard(source, message, agent) {
  window.parent.postMessage({
    type: "crm-notification",
    source,  // e.g. "Leads", "Deals"
    message, // e.g. "New lead: Asad"
    agent    // e.g. "Talha Ali"
  }, "*");
}
    }

    loadFollowups();
  </script>
</body>
</html>
