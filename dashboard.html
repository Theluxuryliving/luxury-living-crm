<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CRM Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Styles -->
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: #111;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid gold;
    }
    .navbar a {
      color: gold;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .top-box {
      background: #222;
      color: gold;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid gold;
    }
    .dashboard-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
    }
    .chart-box {
      background: #1a1a1a;
      border: 1px solid gold;
      border-radius: 10px;
      padding: 20px;
      width: 400px;
    }
    .filters {
      text-align: center;
      margin-top: 10px;
    }
    .filters input, .filters select {
      margin: 5px;
      padding: 8px;
      border-radius: 5px;
      border: none;
    }
    .download-btn {
      background: gold;
      color: black;
      border: none;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px auto;
      display: block;
    }
    .table-container {
      width: 90%;
      margin: 20px auto;
      background: #1a1a1a;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid gold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid gold;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="dashboard.html">Dashboard</a>
    <a href="leads.html">Leads</a>
    <a href="form.html">âž• Add New Client</a>
    <a href="Projects_inventory.html">Inventory</a>
    <a href="Deals.html">Deals</a>
    <a href="Sales_Flow.html">Sales Flow</a>
    <a href="Lead_status.html">Leads Status</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
  <div class="top-box" id="lastSaleBox">Days since last sale: ...</div>
  <div class="filters">
    From: <input type="date" id="startDate" />
    To: <input type="date" id="endDate" />
    Agent: <select id="agentFilter"><option value="">All Agents</option></select>
    <button onclick="loadDashboard()">Apply</button>
    <button class="download-btn" onclick="downloadPDF()">Download PDF</button>
  </div>
  <div class="dashboard-container">
    <div class="chart-box"><canvas id="statusChart"></canvas></div>
    <div class="chart-box"><canvas id="conversionChart"></canvas></div>
    <div class="chart-box"><canvas id="agentPieChart"></canvas></div>
  </div>
  <div class="table-container">
    <h3>Performance Summary</h3>
    <table>
      <thead>
        <tr>
          <th>Agent</th>
          <th>Total Leads</th>
          <th>Contacted</th>
          <th>Closed</th>
          <th>Conversion %</th>
        </tr>
      </thead>
      <tbody id="performanceTable"></tbody>
    </table>
  </div>
  <div class="table-container">
    <h3>Average Conversion Time</h3>
    <table>
      <thead>
        <tr>
          <th>Agent</th>
          <th>Avg Conversion Time</th>
        </tr>
      </thead>
      <tbody id="avgConversionTimeTable"></tbody>
    </table>
  </div>
  <div class="table-container">
    <h3>Top Performing Agents</h3>
    <ol id="topAgentsList"></ol>
  </div>
  <script>
    const db = new PouchDB("crm_leads");

    function logout() {
      localStorage.removeItem("repName");
      window.location.href = "index.html";
    }

    async function loadDashboard() {
      const allDocs = await db.allDocs({ include_docs: true });
      const leads = allDocs.rows.map(r => r.doc);

      const start = document.getElementById("startDate").valueAsDate;
      const end = document.getElementById("endDate").valueAsDate;
      const agent = document.getElementById("agentFilter").value;

      const filtered = leads.filter(lead => {
        const d = new Date(lead.updated_at || lead.created_at);
        const inDateRange = (!start || d >= start) && (!end || d <= end);
        const matchesAgent = !agent || lead.assigned_to === agent;
        return inDateRange && matchesAgent;
      });

      drawStatusChart(filtered);
      drawConversionChart(filtered);
      drawAgentPieChart(filtered);
      updateLastSale(leads);
      populateAgentFilter(leads);
      populatePerformanceTable(filtered);
      populateAvgConversionTimeTable(filtered);
      populateTopAgents(filtered);
    }

    function updateLastSale(leads) {
      const closed = leads.filter(l => l["Lead Status"] === "Closed");
      if (!closed.length) return;
      const last = closed.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))[0];
      const days = Math.floor((Date.now() - new Date(last.updated_at)) / (1000 * 60 * 60 * 24));
      document.getElementById("lastSaleBox").innerText = `Days since last sale: ${days}`;
    }

    function populateAgentFilter(leads) {
      const agents = [...new Set(leads.map(l => l.assigned_to).filter(Boolean))];
      const sel = document.getElementById("agentFilter");
      sel.innerHTML = `<option value="">All Agents</option>` + agents.map(a => `<option>${a}</option>`).join('');
    }

    function drawStatusChart(leads) {
      const counts = {};
      leads.forEach(l => {
        const s = l["Lead Status"] || "New";
        counts[s] = (counts[s] || 0) + 1;
      });

      new Chart(document.getElementById("statusChart"), {
        type: 'pie',
        data: {
          labels: Object.keys(counts),
          datasets: [{ data: Object.values(counts), backgroundColor: ['gold', '#007bff', '#28a745', '#6c757d', '#dc3545'] }]
        },
        options: { plugins: { title: { display: true, text: 'Lead Status Distribution' } } }
      });
    }

    function drawConversionChart(leads) {
      const counts = {};
      leads.forEach(l => {
        const rep = l.assigned_to || "Unassigned";
        if (!counts[rep]) counts[rep] = { total: 0, closed: 0 };
        counts[rep].total++;
        if (l["Lead Status"] === "Closed") counts[rep].closed++;
      });
      const labels = Object.keys(counts);
      const data = labels.map(k => ((counts[k].closed / counts[k].total) * 100).toFixed(1));

      new Chart(document.getElementById("conversionChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: '% Converted', data, backgroundColor: '#17a2b8' }]
        },
        options: {
          plugins: { title: { display: true, text: 'Conversion Rate by Agent' } },
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });
    }

    function drawAgentPieChart(leads) {
      const reps = {};
      leads.forEach(l => {
        const rep = l.assigned_to || "Unassigned";
        reps[rep] = (reps[rep] || 0) + 1;
      });

      new Chart(document.getElementById("agentPieChart"), {
        type: 'pie',
        data: {
          labels: Object.keys(reps),
          datasets: [{ data: Object.values(reps), backgroundColor: ['gold', '#ffc107', '#6c757d', '#007bff', '#28a745'] }]
        },
        options: { plugins: { title: { display: true, text: 'Leads per Agent' } } }
      });
    }

    function populatePerformanceTable(leads) {
      const agents = {};
      leads.forEach(l => {
        const a = l.assigned_to || "Unassigned";
        if (!agents[a]) agents[a] = { total: 0, contacted: 0, closed: 0 };
        agents[a].total++;
        if (l["Lead Status"] === "Contacted") agents[a].contacted++;
        if (l["Lead Status"] === "Closed") agents[a].closed++;
      });
      const tbody = document.getElementById("performanceTable");
      tbody.innerHTML = Object.entries(agents).map(([agent, s]) => {
        const conv = s.total ? ((s.closed / s.total) * 100).toFixed(1) + "%" : "0%";
        return `<tr><td>${agent}</td><td>${s.total}</td><td>${s.contacted}</td><td>${s.closed}</td><td>${conv}</td></tr>`;
      }).join('');
    }

    function populateAvgConversionTimeTable(leads) {
      const agents = {};
      leads.forEach(l => {
        if (l["Lead Status"] === "Closed") {
          const a = l.assigned_to || "Unassigned";
          const days = (new Date(l.updated_at) - new Date(l.created_at)) / (1000 * 60 * 60 * 24);
          if (!agents[a]) agents[a] = [];
          agents[a].push(days);
        }
      });
      const tbody = document.getElementById("avgConversionTimeTable");
      tbody.innerHTML = Object.entries(agents).map(([a, daysArr]) => {
        const avg = (daysArr.reduce((a, b) => a + b, 0) / daysArr.length).toFixed(1);
        return `<tr><td>${a}</td><td>${avg} days</td></tr>`;
      }).join('');
    }

    function populateTopAgents(leads) {
      const agents = {};
      leads.forEach(l => {
        if (l["Lead Status"] === "Closed") {
          const a = l.assigned_to || "Unassigned";
          agents[a] = (agents[a] || 0) + 1;
        }
      });
      const sorted = Object.entries(agents).sort((a, b) => b[1] - a[1]);
      const list = document.getElementById("topAgentsList");
      list.innerHTML = sorted.map(([a, c]) => `<li>${a} - ${c}</li>`).join('');
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      const padding = 20;
      const scale = 2;
      function renderElementToPDF(element, yOffset = 0, callback) {
        html2canvas(element, { scale }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = doc.internal.pageSize.getWidth() - 2 * padding;
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          doc.addImage(imgData, 'PNG', padding, yOffset + padding, pdfWidth, pdfHeight);
          callback(pdfHeight + padding * 2);
        });
      }
      const header = document.querySelector(".top-box");
      const dashboard = document.querySelector(".dashboard-container");
      const tables = document.querySelectorAll(".table-container");
      renderElementToPDF(header, 0, (headerHeight) => {
        renderElementToPDF(dashboard, headerHeight, () => {
          let offset = 0;
          tables.forEach((t, i) => {
            if (i > 0) doc.addPage();
            renderElementToPDF(t, 0, () => {
              if (i === tables.length - 1) doc.save("crm_dashboard.pdf");
            });
          });
        });
      });
    }

    loadDashboard();
  </script>
</body>
</html>
