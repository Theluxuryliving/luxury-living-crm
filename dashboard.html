<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CRM Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #0d0d0d;
      color: white;
      margin: 0;
      padding: 20px;
    }
    .navbar {
      background: #111;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid gold;
    }
    .navbar a {
      color: gold;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    h2 {
      color: gold;
      margin-top: 20px;
    }
    .filters {
      margin: 20px 0;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    select, input[type="month"] {
      padding: 10px;
      background: #1a1a1a;
      color: white;
      border: 1px solid gold;
      border-radius: 6px;
    }
    .metrics {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .card {
      background: #1a1a1a;
      border: 1px solid gold;
      border-radius: 10px;
      padding: 20px;
      flex: 1 1 220px;
      min-width: 200px;
      text-align: center;
    }
    .card h3 {
      color: gold;
      margin-bottom: 10px;
    }
    canvas {
      margin-top: 40px;
      background: #fff;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="navbar">
  <a href="dashboard.html">Dashboard</a>
  <a href="leads.html">Leads</a>
  <a href="form.html">Add Lead</a>
  <a href="deals.html">Deals</a>
  <a href="projects_inventory.html">Inventory</a>
  <a href="sales_flow.html">Sales Flow</a>
  <a href="lead_status.html">Lead Status</a>
</div>

<h2>Agent & Lead Performance Summary</h2>

<div class="filters">
  <select id="filterAgent"><option value="">All Agents</option></select>
  <input type="month" id="filterMonth" />
  <button onclick="loadDashboard()">Apply</button>
</div>

<div class="metrics" id="summaryCards">
  <!-- Summary cards will be injected here -->
</div>

<canvas id="weeklyChart" height="100"></canvas>
<canvas id="monthlyLeadChart" height="100"></canvas>
<canvas id="followupBarChart" height="100"></canvas>
<script>
  const dbLeads = new PouchDB('crm_leads');
  const dbActivities = new PouchDB('crm_activities');
  const dbUsers = new PouchDB('crm_users');

  async function loadAgents() {
    const res = await dbUsers.allDocs({ include_docs: true });
    const select = document.getElementById('filterAgent');
    res.rows.forEach(({ doc }) => {
      if (doc.role === 'sales_rep' || doc.role === 'manager') {
        const opt = document.createElement('option');
        opt.value = doc.name;
        opt.textContent = doc.name;
        select.appendChild(opt);
      }
    });
  }

  async function loadDashboard() {
    const agent = document.getElementById('filterAgent').value;
    const month = document.getElementById('filterMonth').value;
    const selectedMonth = month ? new Date(month + "-01") : null;

    const leads = (await dbLeads.allDocs({ include_docs: true })).rows.map(r => {
      const doc = r.doc;
      doc.status = (doc.status || doc["Lead Status"] || "new").toLowerCase();
      doc.created_at = new Date(doc.created_at || doc._id);
      return doc;
    });

    const activities = (await dbActivities.allDocs({ include_docs: true })).rows.map(r => r.doc);

    // Filter by agent and month
    const filteredLeads = leads.filter(l => {
      const byAgent = !agent || l.assigned_to === agent;
      const byMonth = !selectedMonth || (l.created_at.getMonth() === selectedMonth.getMonth() && l.created_at.getFullYear() === selectedMonth.getFullYear());
      return byAgent && byMonth;
    });

    const filteredActivities = activities.filter(a => {
      const ts = new Date(a.timestamp);
      const byAgent = !agent || a.agent === agent;
      const byMonth = !selectedMonth || (ts.getMonth() === selectedMonth.getMonth() && ts.getFullYear() === selectedMonth.getFullYear());
      return byAgent && byMonth;
    });

    // Count status
    const statusCounts = {};
    const weeklyMap = {};
    const monthlyMap = {};
    const followupCounts = {};

    filteredLeads.forEach(l => {
      const s = l.status;
      statusCounts[s] = (statusCounts[s] || 0) + 1;

      const m = l.created_at.toISOString().slice(0, 7);
      monthlyMap[m] = (monthlyMap[m] || 0) + 1;
    });

    filteredActivities.forEach(a => {
      const d = new Date(a.timestamp).toISOString().slice(0, 10);
      weeklyMap[d] = (weeklyMap[d] || 0) + 1;

      followupCounts[a.agent] = (followupCounts[a.agent] || 0) + 1;
    });

    // Inject summary
    const summary = document.getElementById('summaryCards');
    summary.innerHTML = `
      <div class="card"><h3>Total Leads</h3><p>${filteredLeads.length}</p></div>
      ${Object.entries(statusCounts).map(([s, v]) => `<div class="card"><h3>${s.charAt(0).toUpperCase() + s.slice(1)}</h3><p>${v}</p></div>`).join('')}
      <div class="card"><h3>Follow-ups</h3><p>${filteredActivities.length}</p></div>
    `;

    // Charts
    drawChart('weeklyChart', 'line', Object.keys(weeklyMap), Object.values(weeklyMap), 'Weekly Follow-ups', 'gold');
    drawChart('monthlyLeadChart', 'bar', Object.keys(monthlyMap), Object.values(monthlyMap), 'Monthly Leads Created', 'teal');
    drawChart('followupBarChart', 'bar', Object.keys(followupCounts), Object.values(followupCounts), 'Follow-ups per Agent', 'orange');
  }

  function drawChart(canvasId, type, labels, data, title, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (window[canvasId + '_chart']) window[canvasId + '_chart'].destroy();
    window[canvasId + '_chart'] = new Chart(ctx, {
      type,
      data: {
        labels,
        datasets: [{
          label: title,
          data,
          backgroundColor: color,
          borderColor: color,
          fill: type === 'line' ? false : true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: title
          }
        }
      }
    });
  }

  loadAgents().then(loadDashboard);
</script>

</body>
</html>
